name: ğŸš€ DEV CI/CD - Bbbps Backend

on:
  push:
    branches:
      - dev

jobs:
  deploy-dev:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout code
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js (only for consistency, build nahi ho raha yahan)
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3ï¸âƒ£ Clean unwanted files
      - name: ğŸ§¹ Clean workspace
        run: |
          rm -rf node_modules
          rm -rf .git

      # 4ï¸âƒ£ SSH key test (VERY IMPORTANT)
      - name: ğŸ” Test SSH Connection
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: devserve
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          script: |
            echo "SSH connected as:"
            whoami
            hostname
            pwd

      # 5ï¸âƒ£ Upload code via SCP
      - name: ğŸ“¤ Upload Backend Code (SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: devserve
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          source: |
            .
            !node_modules
            !.git
            !.github
          target: /home/devserve/public_html/Bbbps_Backend
          strip_components: 1

      # 6ï¸âƒ£ Install deps & restart PM2
      - name: ğŸ” Install Dependencies & Restart PM2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: devserve
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          script: |
            cd /home/devserve/public_html/Bbbps_Backend
            npm install --production
            pm2 restart Dev_Bbbps_Backend || pm2 start server.js --name Dev_Bbbps_Backend
            pm2 save
