name: Deploy Node.js Backend to CWP Server (FAST & SAFE)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: üì• Checkout Code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node
      - name: üõ†Ô∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3Ô∏è‚É£ Create TAR (FAST)
      - name: üì¶ Create backend archive
        run: |
          tar --exclude='./uploads' \
              --exclude='./storage' \
              --exclude='./node_modules' \
              --exclude='.git' \
              --exclude='.github' \
              -czf backend.tar.gz .

      # 4Ô∏è‚É£ Upload TAR using SCP (DIRECT)
      - name: üöÄ Upload TAR to Server (FAST SCP)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.BACKEND_SSH_HOST }}
          username: ${{ secrets.BACKEND_SSH_USERNAME }}
          password: ${{ secrets.BACKEND_SSH_PASSWORD }}
          port: ${{ secrets.BACKEND_SSH_PORT }}
          script: |
            scp backend.tar.gz \
              ${{ secrets.BACKEND_SSH_USERNAME }}@${{ secrets.BACKEND_SSH_HOST }}:/home/servefi/

      # 5Ô∏è‚É£ Deploy on Server
      - name: üîê Deploy & Restart
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.BACKEND_SSH_HOST }}
          username: ${{ secrets.BACKEND_SSH_USERNAME }}
          password: ${{ secrets.BACKEND_SSH_PASSWORD }}
          port: ${{ secrets.BACKEND_SSH_PORT }}
          script: |
            APP_DIR="/home/servefi/public_html/Bbbps_Backend"
            BACKUP_DIR="/home/servefi/backup_backend"
            TS=$(date +%Y%m%d_%H%M%S)

            mkdir -p $APP_DIR $BACKUP_DIR

            echo "üõ°Ô∏è Backup"
            cp -r $APP_DIR $BACKUP_DIR/backup_$TS || true

            echo "üì¶ Extract new code"
            rm -rf $APP_DIR/*
            tar -xzf /home/servefi/backend.tar.gz -C $APP_DIR
            rm /home/servefi/backend.tar.gz

            echo "üì¶ Install prod deps"
            cd $APP_DIR
            npm install --production --legacy-peer-deps

            echo "üöÄ Restart PM2"
            pm2 delete Bbbps_Backend || true
            pm2 start server.js --name "Bbbps_Backend"
            pm2 save

            echo "‚úÖ DONE"
