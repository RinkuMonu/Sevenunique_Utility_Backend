name: Deploy Node.js Backend to CWP Server (PROD)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: üì• Checkout Code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node (optional, safe)
      - name: üõ†Ô∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3Ô∏è‚É£ Deploy using RSYNC (NO TAR, NO SCP-ACTION)
      - name: üöÄ Deploy Backend via RSYNC
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.BACKEND_SSH_HOST }}
          username: ${{ secrets.BACKEND_SSH_USERNAME }}
          password: ${{ secrets.BACKEND_SSH_PASSWORD }}
          port: ${{ secrets.BACKEND_SSH_PORT }}
          script: |
            echo "üöÄ STARTING PRODUCTION DEPLOY"

            APP_DIR="/home/servefi/public_html/Bbbps_Backend"
            BACKUP_DIR="/home/servefi/backup_backend"
            TMP_DIR="/home/servefi/tmp_backend"
            TS=$(date +%Y%m%d_%H%M%S)

            mkdir -p $APP_DIR $BACKUP_DIR $TMP_DIR

            echo "üõ°Ô∏è Backup current backend"
            cp -r $APP_DIR $BACKUP_DIR/backup_$TS || true

            echo "üßπ Cleanup old backups"
            find $BACKUP_DIR -mindepth 1 -mtime +10 -exec rm -rf {} \; || true

            echo "üì§ Sync new code to temp"
            rsync -az --delete \
              --exclude node_modules \
              --exclude uploads \
              --exclude storage \
              --exclude .git \
              --exclude .github \
              --exclude "*.log" \
              --exclude ".env" \
              $GITHUB_WORKSPACE/ \
              $TMP_DIR/

            echo "üîê Preserve .env"
            [ -f "$APP_DIR/.env" ] && cp $APP_DIR/.env /home/servefi/.env_backup

            echo "üöö Replace backend"
            rm -rf $APP_DIR/*
            cp -r $TMP_DIR/* $APP_DIR/
            rm -rf $TMP_DIR

            echo "‚ôªÔ∏è Restore .env"
            [ -f "/home/servefi/.env_backup" ] && mv /home/servefi/.env_backup $APP_DIR/.env

            echo "üì¶ Install prod dependencies"
            cd $APP_DIR
            npm install --production --legacy-peer-deps

            echo "üöÄ Restart PM2"
            pm2 reload Bbbps_Backend || pm2 start server.js --name "Bbbps_Backend"
            pm2 save

            echo "‚úÖ PRODUCTION DEPLOY DONE"
